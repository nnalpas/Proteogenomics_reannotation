##################################
# Install Kernel on Raspberry Pi #
##################################

# Create a working directory
cd /home/pi/
mkdir ./workingarea/
cd !&

# Get the sources, which will take some time
nohup git clone --depth=1 https://github.com/raspberrypi/linux &

# Add missing dependencies
nohup sudo apt-get install bc &

# Enter the linux directory
cd linux

# Configure the kernel by default
nohup make bcmrpi_defconfig &

# Create a shell script to build the kernel
echo "make; make modules; sudo make modules_install; sudo cp arch/arm/boot/Image /boot/kernel.img" > Build_kernel.sh

# Run the shell script on Raspberry
chmod 755 ./Build_kernel.sh
nohup ./Build_kernel.sh &

############################
# Install drivers for WIFI #
############################

# Go to working directory
cd /home/pi/workingarea/

# Get driver sources (from gnab's modified version because it include config for rpi)
git clone https://github.com/gnab/rtl8812au
cd rtl8812au

# Configure the Makefile for Raspberry installation (pick RPI platform and disable others)
nano Makefile

# Build module
make

# Install modul
sudo make install

# Load module
sudo modprobe 8812au

# Check that your usb dongle is working
iwconfig

###########################
# Connect to WIFI network #
###########################

# Scan for WiFi networks
sudo iwlist wlan0 scan

# Open the wpa-supplicant configuration file
sudo nano /etc/wpa_supplicant/wpa_supplicant.conf

# Go to the bottom of the file and add the following:
# network={
#     ssid="ESSID"
#     psk="Password"
# }

# Manually restart the interface
sudo ifdown wlan0
sudo ifup wlan0

# Retrieve your existing IP address and network information
sudo ifconfig

# Get your gateway (in most cases your routers internal IP address)
sudo route -nee

# Modify the network interfaces
sudo nano /etc/network/interfaces

# To add the following
# iface wlan0 inet manual
# wpa-roam /etc/wpa_supplicant/wpa_supplicant.conf
# 
# iface home inet static
# address 192.168.1.16
# netmask 255.255.255.0
# gateway 192.168.1.1
# 
# iface default inet dhcp

# Modify the WPA supplicant
sudo nano /etc/wpa_supplicant/wpa_supplicant.conf

# To add the following
network={
    ssid="ESSID"
    scan_ssid=1
    psk="Password"
    key_mgmt=WPA-PSK
    id_str="home"
    priority=15
}

# Note: The key to it is the id_str option in the wpa_supplicant.conf file; this refers back to the home interface in the interfaces file

# Reboot the Raspberry
sudo reboot

